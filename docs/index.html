<!-- index.html Ã©purÃ© -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ðŸŽµ St Vince â€“ Music & Climate</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/wavesurfer.js"></script>
</head>
<body>

<header class="minimal-header">
    <div class="brand">
        <span class="logo">ðŸŽµ</span>
        <div class="text-block">
            <div class="title">St Vince</div>
            <div class="subtitle" id="header-sub">Original music with a human soul and an AI spark</div>
        </div>
    </div>
    <div class="language-switch">
        <button onclick="setLanguage('fr')">ðŸ‡«ðŸ‡· FR</button>
        <button onclick="setLanguage('en')">ðŸ‡¬ðŸ‡§ EN</button>
    </div>
</header>

<main id="content"></main>

<footer>
    <p>&copy; 2025 Vincent Lagny â€“ Version 1.31 â€“ Licence CC BY-NC-SA 4.0</p>
</footer>

<script>
    let isHiFi = false;
    let currentPlaying = null;
    const players = [];

    const translations = {
        en: {
            downloadHifi: "â¬‡ï¸ Download in HiFi (.flac)"
        },
        fr: {
            downloadHifi: "â¬‡ï¸ TÃ©lÃ©charger en HiFi (.flac)"
        }
    };

    function getDownloadLink(url) {
        const match = url.match(/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)\//);
        if (match) {
            const fileId = match[1];
            return `https://drive.google.com/uc?export=download&id=${fileId}`;
        }
        return url; // fallback: retourne l'URL telle quelle si ce nâ€™est pas un lien GDrive
    }

    function renderTracks(lang = 'en') {
        fetch('./assets/data/tracks.json')
            .then(res => res.json())
            .then(data => {
                const { tracks, desc } = data;
                const container = document.getElementById('content');
                container.innerHTML = '';
                tracks.forEach(track => {
                    const trackDesc = desc[lang][track.id] || [];
                    const format = isHiFi ? 'wav' : 'mp3';
                    const audioPath = `assets/audio/${format}/${track.file}.${format}`;
                    const hifiPath = track.hifi;

                    const section = document.createElement('section');
                    section.className = 'track';
                    section.setAttribute('data-audio', audioPath);

                    section.innerHTML = `
                  <div class="cover-container">
                    <img src="assets/covers/${track.cover}" class="cover" alt="${track.title}" />
                    <div class="icon-overlay play"></div>
                  </div>
                  <div class="info">
                    <h2>${track.title}</h2>
                    ${trackDesc.map(p => `<p>${p}</p>`).join('')}
                    <div class="waveform"></div>
                    <div class="playback-time" style="font-size: 0.8em; color: #666; margin-top: 4px;">--:-- / --:--</div>
                    <p><a href="${getDownloadLink(track.hifi)}" class="hifi-link" target="_blank" rel="noopener">${translations[lang].downloadHifi}</a></p>
                  </div>
                `;

                    container.appendChild(section);
                });
                initializeWaveSurfers();
            });
    }


    function initializeWaveSurfers() {
        players.length = 0;
        document.querySelectorAll('.track').forEach(track => {
            const container = track.querySelector('.waveform');
            const durationElement = track.querySelector('.duration');
            const playbackElement = track.querySelector('.playback-time');
            const coverContainer = track.querySelector('.cover-container');
            const iconOverlay = track.querySelector('.icon-overlay');
            const baseFilename = track.getAttribute('data-audio').match(/([^/]+)\.(mp3|wav)$/)[1];
            const format = isHiFi ? 'wav' : 'mp3';

            const wavesurfer = WaveSurfer.create({
                container,
                waveColor: '#999',
                progressColor: '#ff7b54',
                height: 80,
                responsive: true,
                barWidth: 2,
                cursorColor: '#fff'
            });

            wavesurfer.load(`assets/audio/${format}/${baseFilename}.${format}`);

            coverContainer.onclick = () => {
                if (currentPlaying && currentPlaying !== wavesurfer) {
                    currentPlaying.pause();
                }
                wavesurfer.playPause();
                if (wavesurfer.isPlaying()) {
                    currentPlaying = wavesurfer;
                }
            };

            wavesurfer.on('ready', () => {
                const durationSec = wavesurfer.getDuration();
                const minutes = Math.floor(durationSec / 60);
                const seconds = Math.round(durationSec % 60).toString().padStart(2, '0');
                playbackElement.textContent = `0:00 / ${minutes}:${seconds}`;
            });

            wavesurfer.on('audioprocess', () => {
                const current = wavesurfer.getCurrentTime();
                const duration = wavesurfer.getDuration();

                const minC = Math.floor(current / 60);
                const secC = Math.floor(current % 60).toString().padStart(2, '0');

                const minT = Math.floor(duration / 60);
                const secT = Math.round(duration % 60).toString().padStart(2, '0');

                playbackElement.textContent = `${minC}:${secC} / ${minT}:${secT}`;
            });

            wavesurfer.on('play', () => {
                iconOverlay.classList.remove('play');
                iconOverlay.classList.add('pause');
            });
            wavesurfer.on('pause', () => {
                iconOverlay.classList.remove('pause');
                iconOverlay.classList.add('play');
            });
            wavesurfer.on('finish', () => {
                const duration = wavesurfer.getDuration();
                const minT = Math.floor(duration / 60);
                const secT = Math.round(duration % 60).toString().padStart(2, '0');
                playbackElement.textContent = `0:00 / ${minT}:${secT}`;
                iconOverlay.classList.remove('pause');
                iconOverlay.classList.add('play');
                currentPlaying = null;
            });

            players.push({ wavesurfer });
        });
    }

    function setLanguage(lang) {
        localStorage.setItem('lang', lang);
        renderTracks(lang);
        document.getElementById('header-sub').textContent =
            lang === 'fr'
                ? "Des musiques originales, composÃ©es par un humain et une IA â€” un reflet musical du climat."
                : "Original music with a human soul and an AI spark";
    }

    window.addEventListener('DOMContentLoaded', () => {
        const lang = localStorage.getItem('lang') || 'en';
        setLanguage(lang);
    });
</script>

</body>
</html>
