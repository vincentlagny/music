<!-- index.html Ã©purÃ© -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ðŸŽµ St Vince â€“ Music & Climate</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/wavesurfer.js"></script>
</head>
<body>

<header class="minimal-header">
    <div class="brand">
        <span class="logo">ðŸŽµ</span>
        <div class="text-block">
            <div class="title">St Vince</div>
            <div class="subtitle" id="header-sub">Original music with a human soul and an AI spark</div>
        </div>
    </div>
    <div class="language-switch">
        <button onclick="setLanguage('fr')">ðŸ‡«ðŸ‡· FR</button>
        <button onclick="setLanguage('en')">ðŸ‡¬ðŸ‡§ EN</button>
    </div>
</header>

<main id="content"></main>

<div id="volume-control">
    <button id="rewind-global" title="Rewind current track" aria-label="Rewind current track">
        <svg viewBox="0 0 24 24" width="24" height="24" fill="#888">
            <path d="M11 18V6l-8.5 6L11 18zM13 6v12l8.5-6L13 6z"/>
        </svg>
    </button>

    <button id="loop-track" title="Loop current track" aria-label="Loop current track">
        <svg viewBox="0 0 24 24" width="24" height="24" fill="#888" class="icon-loop">
            <path d="M7 7h9v2l3-3-3-3v2H6c-1.1 0-2 .9-2 2v4h2V7z"/>
            <text x="17" y="21" font-size="8" fill="#888">1</text>
        </svg>
    </button>

    <button id="loop-all" title="Loop all tracks"  aria-label="Loop all tracks">
        <svg viewBox="0 0 24 24" width="24" height="24" fill="#888" class="icon-loop-all">
            <path d="M7 7h9v2l3-3-3-3v2H6c-1.1 0-2 .9-2 2v4h2V7z"/>
            <text x="15" y="21" font-size="8" fill="#888">âˆž</text>
        </svg>
    </button>

    <button id="mute-toggle" title="Mute / Unmute">
        <svg id="volume-icon" viewBox="0 0 24 24" width="24" height="24" fill="#888">
            <path id="volume-on" d="M3 9v6h4l5 5V4L7 9H3z"/>
            <path id="volume-off" d="M16.5 12l2.5 2.5-1.5 1.5L15 13.5l-2.5 2.5-1.5-1.5L13.5 12l-2.5-2.5 1.5-1.5L15 10.5l2.5-2.5 1.5 1.5L16.5 12z" style="display: none"/>
        </svg>
    </button>

    <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1">
</div>

<footer>
    <p>&copy; 2025 Vincent Lagny â€“ Version 1.35 â€“ Licence CC BY-NC-SA 4.0</p>
</footer>

<script>
    let isHiFi = false;
    let currentPlaying = null;
    const players = [];

    const translations = {
        en: {
            downloadHifi: "â¬‡ï¸ Download in HiFi (.flac)"
        },
        fr: {
            downloadHifi: "â¬‡ï¸ TÃ©lÃ©charger en HiFi (.flac)"
        }
    };

    function formatTime(seconds) {
        const m = Math.floor(seconds / 60);
        const s = Math.floor(seconds % 60);
        return `${m}:${s.toString().padStart(2, '0')}`;
    }

    function getDownloadLink(url) {
        const match = url.match(/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)\//);
        if (match) {
            const fileId = match[1];
            return `https://drive.google.com/uc?export=download&id=${fileId}`;
        }
        return url; // fallback: retourne l'URL telle quelle si ce nâ€™est pas un lien GDrive
    }

    function renderTracks(lang = 'en') {
        fetch('./assets/data/tracks.json')
            .then(res => res.json())
            .then(data => {
                const { tracks, desc } = data;
                const container = document.getElementById('content');
                container.innerHTML = '';
                tracks.forEach(track => {
                    const trackDesc = desc[lang][track.id] || [];
                    const format = isHiFi ? 'wav' : 'mp3';
                    const audioPath = `assets/audio/${format}/${track.file}.${format}`;
                    const hifiPath = track.hifi;

                    const section = document.createElement('section');
                    section.className = 'track';
                    section.setAttribute('data-audio', audioPath);

                    section.innerHTML = `
                  <div class="cover-container">
                    <img src="assets/covers/${track.cover}" class="cover" alt="${track.title}" />
                    <div class="icon-overlay play"></div>
                  </div>
                  <div class="info">
                    <h2>${track.title}</h2>
                    ${trackDesc.map(p => `<p>${p}</p>`).join('')}
                    <div class="waveform"></div>
                    <p class="duration-controls">
                        <span class="duration" style="font-size: 0.8em; color: #666; margin-top: 4px;">00:00 / 00:00</span>
                    </p>
                    <p><a href="${getDownloadLink(track.hifi)}" class="hifi-link" target="_blank" rel="noopener">${translations[lang].downloadHifi}</a></p>
                  </div>
                `;

                    container.appendChild(section);
                });
                initializeWaveSurfers();
            });
    }


    function initializeWaveSurfers() {
        players.length = 0;
        document.querySelectorAll('.track').forEach(track => {
            const container = track.querySelector('.waveform');
            const durationEl = track.querySelector('.duration');
            let isLooping = false;

            const durationElement = track.querySelector('.duration');
            const playbackElement = track.querySelector('.playback-time');
            const coverContainer = track.querySelector('.cover-container');
            const iconOverlay = track.querySelector('.icon-overlay');
            const baseFilename = track.getAttribute('data-audio').match(/([^/]+)\.(mp3|wav)$/)[1];
            const format = isHiFi ? 'wav' : 'mp3';

            const wavesurfer = WaveSurfer.create({
                container,
                waveColor: '#999',
                progressColor: '#ff7b54',
                height: 80,
                responsive: true,
                barWidth: 2,
                cursorColor: '#fff'
            });

            wavesurfer.setVolume(parseFloat(volumeSlider.value));
            wavesurfer.load(`assets/audio/${format}/${baseFilename}.${format}`);

            coverContainer.onclick = () => {
                if (currentPlaying && currentPlaying !== wavesurfer) {
                    currentPlaying.pause();
                }
                wavesurfer.playPause();
                if (wavesurfer.isPlaying()) {
                    currentPlaying = wavesurfer;
                }
            };

            wavesurfer.on('ready', () => {
                const total = formatTime(wavesurfer.getDuration());
                durationEl.textContent = `00:00 / ${total}`;
            });


            wavesurfer.on('audioprocess', () => {
                const current = formatTime(wavesurfer.getCurrentTime());
                const total = formatTime(wavesurfer.getDuration());
                durationEl.textContent = `${current} / ${total}`;
            });


            wavesurfer.on('play', () => {
                iconOverlay.classList.remove('play');
                iconOverlay.classList.add('pause');
            });
            wavesurfer.on('pause', () => {
                iconOverlay.classList.remove('pause');
                iconOverlay.classList.add('play');
            });

            wavesurfer.on('finish', () => {
                iconOverlay.classList.remove('pause');
                iconOverlay.classList.add('play');

                if (loopMode === 1 && currentPlaying === wavesurfer) {
                    wavesurfer.seekTo(0);
                    wavesurfer.play();
                } else if (loopMode === 2) {
                    wavesurfer.seekTo(0);
                    wavesurfer.play();
                } else {
                    currentPlaying = null;
                }
            });



            players.push({ wavesurfer });
        });
    }

    function setLanguage(lang) {
        localStorage.setItem('lang', lang);
        renderTracks(lang);
        document.getElementById('header-sub').textContent =
            lang === 'fr'
                ? "Des musiques originales, composÃ©es par un humain et une IA â€” un reflet musical du climat."
                : "Original music with a human soul and an AI spark";
    }

    window.addEventListener('DOMContentLoaded', () => {
        const lang = localStorage.getItem('lang') || 'en';
        setLanguage(lang);
    });


    document.getElementById('rewind-global').addEventListener('click', () => {
        if (currentPlaying) {
            currentPlaying.seekTo(0);
        }
    });


    // RÃ©fÃ©rences des nouveaux boutons globaux
    const rewindBtn = document.getElementById('rewind-global');
    const loopTrackBtn = document.getElementById('loop-track');
    const loopAllBtn = document.getElementById('loop-all');

    let loopCurrentTrack = false;
    let loopAllTracks = false;

    rewindBtn.addEventListener('click', () => {
        if (currentPlaying) {
            currentPlaying.seekTo(0);
        }
    });

    loopTrackBtn.addEventListener('click', () => {
        loopCurrentTrack = !loopCurrentTrack;
        loopTrackBtn.classList.toggle('active', loopCurrentTrack);
    });

    loopAllBtn.addEventListener('click', () => {
        loopAllTracks = !loopAllTracks;
        loopAllBtn.classList.toggle('active', loopAllTracks);
    });



    const volumeSlider = document.getElementById('volume-slider');
    const muteToggle = document.getElementById('mute-toggle');
    const volumeIcon = document.getElementById('volume-icon');
    const pathOn = volumeIcon.querySelector('#volume-on');
    const pathOff = volumeIcon.querySelector('#volume-off');
    let isMuted = false;
    let lastVolume = 1;

    volumeSlider.addEventListener('input', () => {
        const newVolume = parseFloat(volumeSlider.value);
        players.forEach(({ wavesurfer }) => wavesurfer.setVolume(newVolume));
        isMuted = newVolume === 0;
        updateVolumeIcon();
        lastVolume = newVolume;
    });

    muteToggle.addEventListener('click', () => {
        isMuted = !isMuted;
        if (isMuted) {
            players.forEach(({ wavesurfer }) => wavesurfer.setVolume(0));
            volumeSlider.value = 0;
        } else {
            players.forEach(({ wavesurfer }) => wavesurfer.setVolume(lastVolume));
            volumeSlider.value = lastVolume;
        }
        updateVolumeIcon();
    });

    function updateVolumeIcon() {
        pathOn.style.display = isMuted ? 'none' : '';
        pathOff.style.display = isMuted ? '' : 'none';
    }



</script>


</body>
</html>
