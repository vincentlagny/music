<!-- index.html épuré -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>🎵 St Vince – Music & Climate</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/wavesurfer.js"></script>
</head>
<body>

<header class="minimal-header">
    <div class="brand">
        <span class="logo">🎵</span>
        <div class="text-block">
            <div class="title">St Vince</div>
            <div class="subtitle" id="header-sub">Original music with a human soul and an AI spark</div>
        </div>
    </div>
    <div class="language-switch">
        <button onclick="setLanguage('fr')">🇫🇷 FR</button>
        <button onclick="setLanguage('en')">🇬🇧 EN</button>
    </div>
</header>

<main id="content"></main>

<div id="volume-control">

    <div id="now-playing-cover" >
        <img src="assets/covers/empty.png" alt="Current cover" id="cover-image" style="width: 100%; height: 100%; object-fit: cover; border-radius: 6px;">
    </div>

    <!-- Groupe des boutons -->
    <div class="button-row">
        <button id="rewind-global" title="Rewind current track" aria-label="Rewind current track">
            <!-- License: MIT. Made by teenyicons: https://github.com/teenyicons/teenyicons -->
            <svg viewBox="0 0 24 24" width="24" height="24" fill="#888">
                <path d="M8 2.5C8 2.31271 7.89533 2.14112 7.72879 2.05542C7.56226 1.96972 7.36179 1.98427 7.20938 2.09314L0.209381 7.09314C0.0779829 7.18699 0 7.33853 0 7.5C0 7.66148 0.0779829 7.81301 0.209381 7.90687L7.20938 12.9069C7.36179 13.0157 7.56226 13.0303 7.72879 12.9446C7.89533 12.8589 8 12.6873 8 12.5V8.4716L14.2094 12.9069C14.3618 13.0157 14.5623 13.0303 14.7288 12.9446C14.8953 12.8589 15 12.6873 15 12.5V2.5C15 2.31271 14.8953 2.14112 14.7288 2.05542C14.5623 1.96972 14.3618 1.98427 14.2094 2.09314L8 6.52841V2.5Z" fill="#000000"/>
            </svg>
        </button>

        <!-- Bouton Play/Pause -->
        <button id="play-pause-toggle" title="Play / Pause">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="#888">
                <path id="play-icon" d="M8 5v14l11-7z"/>
                <path id="pause-icon" d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" style="display: none"/>
            </svg>
        </button>

        <!-- Bouton Next -->
        <button id="next-track" title="Next track">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="#888">
                <path d="M7 6v12l8.5-6L7 6zm9 0v12h2V6h-2z"/>
            </svg>
        </button>

        <!-- Bouton Loop -->
        <button id="loop-toggle" title="Loop mode" aria-label="Loop mode">
            <svg id="loop-icon" viewBox="0 0 24 24" width="24" height="24" fill="#888">
                <!-- Mode LOOP OFF (défaut) -->
                <g id="loop-off-icon">
                    <path d="M14.5 3.5L14.8536 3.85355C15.0488 3.65829 15.0488 3.34171 14.8536 3.14645L14.5 3.5ZM0.5 11.5L0.146447 11.1464C-0.0488153 11.3417 -0.0488153 11.6583 0.146447 11.8536L0.5 11.5ZM11.1464 0.853553L14.1464 3.85355L14.8536 3.14645L11.8536 0.146447L11.1464 0.853553ZM14.1464 3.14645L11.1464 6.14645L11.8536 6.85355L14.8536 3.85355L14.1464 3.14645ZM3.85355 14.1464L0.853554 11.1464L0.146447 11.8536L3.14644 14.8536L3.85355 14.1464ZM0.853554 11.8536L3.85355 8.85355L3.14645 8.14645L0.146447 11.1464L0.853554 11.8536ZM0.5 12H11.5V11H0.5V12ZM15 8.5V7H14V8.5H15ZM11.5 12C13.433 12 15 10.433 15 8.5H14C14 9.88071 12.8807 11 11.5 11V12ZM14.5 3H3.5V4H14.5V3ZM0 6.5V8H1V6.5H0ZM3.5 3C1.567 3 0 4.567 0 6.5H1C1 5.11929 2.11929 4 3.5 4V3Z" fill="#000000"/>
                </g>

                <!-- Mode LOOP ONE -->
                <g id="loop-one-icon" style="display: none;">
                    <path d="M14.5 3.5L14.8536 3.85355C15.0488 3.65829 15.0488 3.34171 14.8536 3.14645L14.5 3.5ZM0.5 11.5L0.146447 11.1464C-0.0488153 11.3417 -0.0488153 11.6583 0.146447 11.8536L0.5 11.5ZM11.1464 0.853553L14.1464 3.85355L14.8536 3.14645L11.8536 0.146447L11.1464 0.853553ZM14.1464 3.14645L11.1464 6.14645L11.8536 6.85355L14.8536 3.85355L14.1464 3.14645ZM3.85355 14.1464L0.853554 11.1464L0.146447 11.8536L3.14644 14.8536L3.85355 14.1464ZM0.853554 11.8536L3.85355 8.85355L3.14645 8.14645L0.146447 11.1464L0.853554 11.8536ZM0.5 12H11.5V11H0.5V12ZM15 8.5V7H14V8.5H15ZM11.5 12C13.433 12 15 10.433 15 8.5H14C14 9.88071 12.8807 11 11.5 11V12ZM14.5 3H3.5V4H14.5V3ZM0 6.5V8H1V6.5H0ZM3.5 3C1.567 3 0 4.567 0 6.5H1C1 5.11929 2.11929 4 3.5 4V3Z" fill="#000000"/>
                    <path d="M128,20A108,108,0,1,0,236,128,108.12186,108.12186,0,0,0,128,20Zm0,192a84,84,0,1,1,84-84A84.09562,84.09562,0,0,1,128,212ZM144,84v92a12,12,0,0,1-24,0V106.417l-5.3457,3.5625a12.00027,12.00027,0,1,1-13.3086-19.97265l24-15.99317A12.00071,12.00071,0,0,1,144,84Z"/>
                </g>

                <!-- Mode LOOP ALL -->
                <g id="loop-all-icon" style="display: none;">
                    <path d="M14.5 3.5L14.8536 3.85355C15.0488 3.65829 15.0488 3.34171 14.8536 3.14645L14.5 3.5ZM0.5 11.5L0.146447 11.1464C-0.0488153 11.3417 -0.0488153 11.6583 0.146447 11.8536L0.5 11.5ZM11.1464 0.853553L14.1464 3.85355L14.8536 3.14645L11.8536 0.146447L11.1464 0.853553ZM14.1464 3.14645L11.1464 6.14645L11.8536 6.85355L14.8536 3.85355L14.1464 3.14645ZM3.85355 14.1464L0.853554 11.1464L0.146447 11.8536L3.14644 14.8536L3.85355 14.1464ZM0.853554 11.8536L3.85355 8.85355L3.14645 8.14645L0.146447 11.1464L0.853554 11.8536ZM0.5 12H11.5V11H0.5V12ZM15 8.5V7H14V8.5H15ZM11.5 12C13.433 12 15 10.433 15 8.5H14C14 9.88071 12.8807 11 11.5 11V12ZM14.5 3H3.5V4H14.5V3ZM0 6.5V8H1V6.5H0ZM3.5 3C1.567 3 0 4.567 0 6.5H1C1 5.11929 2.11929 4 3.5 4V3Z" fill="#000000"/>
                </g>
            </svg>
        </button>

        <!-- Bouton Mute -->
        <button id="mute-toggle" title="Mute / Unmute">
            <svg id="volume-icon" viewBox="0 0 24 24" width="24" height="24" fill="#888">
                <path id="volume-on" d="M3 9v6h4l5 5V4L7 9H3z"/>
                <path id="volume-off" d="M16.5 12l2.5 2.5-1.5 1.5L15 13.5l-2.5 2.5-1.5-1.5L13.5 12l-2.5-2.5 1.5-1.5L15 10.5l2.5-2.5 1.5 1.5L16.5 12z" style="display: none"/>
            </svg>
        </button>
    </div>

    <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1">
</div>

<footer>
    <p id="footer-info" style="opacity: 0.5;">Version en cours de chargement…</p>
</footer>

<script>
    let isHiFi = false;
    let currentPlaying = null;
    const players = [];
    let loopMode = 0; // 0 = no loop, 1 = loop current, 2 = loop all

    const translations = {
        en: {
            downloadHifi: "⬇️ Download in HiFi (.flac)"
        },
        fr: {
            downloadHifi: "⬇️ Télécharger en HiFi (.flac)"
        }
    };

    function formatTime(seconds) {
        const m = Math.floor(seconds / 60);
        const s = Math.floor(seconds % 60);
        return `${m}:${s.toString().padStart(2, '0')}`;
    }

    function getDownloadLink(url) {
        const match = url.match(/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)\//);
        if (match) {
            const fileId = match[1];
            return `https://drive.google.com/uc?export=download&id=${fileId}`;
        }
        return url; // fallback: retourne l'URL telle quelle si ce n’est pas un lien GDrive
    }

    function renderTracks(lang = 'en') {
        fetch('./assets/data/tracks.json')
            .then(res => res.json())
            .then(data => {
                const { tracks, desc } = data;
                const container = document.getElementById('content');
                container.innerHTML = '';
                tracks.forEach(track => {
                    const trackDesc = desc[lang][track.id] || [];
                    const format = isHiFi ? 'wav' : 'mp3';
                    const audioPath = `assets/audio/${format}/${track.file}.${format}`;
                    const hifiPath = track.hifi;

                    const section = document.createElement('section');
                    section.className = 'track';
                    section.setAttribute('data-audio', audioPath);

                    section.innerHTML = `
                  <div class="cover-container">
                    <img src="assets/covers/${track.cover}" class="cover" alt="${track.title}" />
                    <div class="icon-overlay play"></div>
                  </div>
                  <div class="info">
                    <h2>${track.title}</h2>
                    ${trackDesc.map(p => `<p>${p}</p>`).join('')}
                    <div class="waveform"></div>
                    <p class="duration-controls">
                        <span class="duration" style="font-size: 0.8em; color: #666; margin-top: 4px;">00:00 / 00:00</span>
                    </p>
                    <p><a href="${getDownloadLink(track.hifi)}" class="hifi-link" target="_blank" rel="noopener">${translations[lang].downloadHifi}</a></p>
                  </div>
                `;

                    container.appendChild(section);
                });
                initializeWaveSurfers();
            });
    }


    function initializeWaveSurfers() {
        players.length = 0;
        document.querySelectorAll('.track').forEach(track => {
            const container = track.querySelector('.waveform');
            const durationEl = track.querySelector('.duration');
            let isLooping = false;

            const durationElement = track.querySelector('.duration');
            const playbackElement = track.querySelector('.playback-time');
            const coverContainer = track.querySelector('.cover-container');
            const iconOverlay = track.querySelector('.icon-overlay');
            const baseFilename = track.getAttribute('data-audio').match(/([^/]+)\.(mp3|wav)$/)[1];
            const format = isHiFi ? 'wav' : 'mp3';

            const wavesurfer = WaveSurfer.create({
                container,
                waveColor: '#999',
                progressColor: '#ff7b54',
                height: 80,
                responsive: true,
                barWidth: 2,
                cursorColor: '#fff'
            });

            wavesurfer.setVolume(parseFloat(volumeSlider.value));
            wavesurfer.load(`assets/audio/${format}/${baseFilename}.${format}`);

            coverContainer.onclick = () => {
                if (currentPlaying && currentPlaying !== wavesurfer) {
                    currentPlaying.pause();
                }
                wavesurfer.playPause();
                currentPlaying = wavesurfer;

                // 🎵 Mise à jour de la pochette dans le bloc global
                const coverImg = track.querySelector('.cover');
                const globalCover = document.getElementById('cover-image');
                if (coverImg && globalCover) {
                    globalCover.src = coverImg.src;
                }
            };

            wavesurfer.on('ready', () => {
                const total = formatTime(wavesurfer.getDuration());
                durationEl.textContent = `00:00 / ${total}`;
            });


            wavesurfer.on('audioprocess', () => {
                const current = formatTime(wavesurfer.getCurrentTime());
                const total = formatTime(wavesurfer.getDuration());
                durationEl.textContent = `${current} / ${total}`;
            });


            wavesurfer.on('play', () => {
                iconOverlay.classList.remove('play');
                iconOverlay.classList.add('pause');
                updatePlayPauseIcon(true); // 🔁 met à jour l’icône globale
            });
            wavesurfer.on('pause', () => {
                iconOverlay.classList.remove('pause');
                iconOverlay.classList.add('play');
                updatePlayPauseIcon(false); // 🔁 met à jour l’icône globale
            });

            wavesurfer.on('finish', () => {
                iconOverlay.classList.remove('pause');
                iconOverlay.classList.add('play');

                if (loopMode === 1 && currentPlaying === wavesurfer) {
                    wavesurfer.seekTo(0);
                    wavesurfer.play();
                } else if (loopMode === 2) {
                    const currentIndex = players.findIndex(p => p.wavesurfer === wavesurfer);
                    const nextIndex = (currentIndex + 1) % players.length;
                    const nextPlayer = players[nextIndex].wavesurfer;

                    nextPlayer.seekTo(0);
                    nextPlayer.play();
                    currentPlaying = nextPlayer;

                    const globalCover = document.getElementById('cover-image');
                    const nextCover = document.querySelectorAll('.track')[nextIndex].querySelector('.cover');
                    if (nextCover && globalCover) {
                        globalCover.src = nextCover.src;
                    }
                } else {
                    currentPlaying = null;

                    // 🕊️ Image par défaut
                    const globalCover = document.getElementById('cover-image');
                    if (globalCover) {
                        globalCover.src = 'assets/covers/empty.png';
                    }
                }

            });

            // Clic sur le graph wave pour avancer dans le son
            wavesurfer.on('interaction', (event) => {
                const bounding = wavesurfer.container.getBoundingClientRect();
                const x = event.clientX - bounding.left;
                const width = bounding.width;

                const percent = x / width;
                const duration = wavesurfer.getDuration();
                const seekTo = percent * duration;

                wavesurfer.seekTo(percent); // méthode officielle de WaveSurfer
            });




            players.push({ wavesurfer });
        });
    }

    ////////////////////////////// GESTION DE LA LANGUE
    function setLanguage(lang) {
        localStorage.setItem('lang', lang);
        renderTracks(lang);
        document.getElementById('header-sub').textContent =
            lang === 'fr'
                ? "Des musiques originales, composées par un humain et une IA — un reflet musical du climat."
                : "Original music with a human soul and an AI spark";
    }

    window.addEventListener('DOMContentLoaded', () => {
        const lang = localStorage.getItem('lang') || 'en';
        setLanguage(lang);
    });

    ////////////////////////////// VERSION ET PIED DE PAGE
    fetch('version.json')
        .then(res => res.json())
        .then(data => {
            const footer = document.getElementById('footer-info');
            const version = data.version || 'x.x';
            const date = data.buildDate ? ` (${data.buildDate})` : '';
            footer.textContent = `© 2025 Vincent Lagny – Version ${version}${date} – Licence CC BY-NC-SA 4.0`;
        });

    document.getElementById('rewind-global').addEventListener('click', () => {
        if (currentPlaying) {
            currentPlaying.seekTo(0);
        }
    });


    ////////////////////////////// Bouton LOOP
    const rewindBtn = document.getElementById('rewind-global');

    let loopCurrentTrack = false;
    let loopAllTracks = false;

    rewindBtn.addEventListener('click', () => {
        if (currentPlaying) {
            currentPlaying.seekTo(0);
        }
    });

    const loopToggleBtn = document.getElementById('loop-toggle');
    const loopOffIcon = document.getElementById('loop-off-icon');
    const loopOneIcon = document.getElementById('loop-one-icon');
    const loopAllIcon = document.getElementById('loop-all-icon');

    function updateLoopIcon(mode) {
        loopOffIcon.style.display = mode === 0 ? '' : 'none';
        loopOneIcon.style.display = mode === 1 ? '' : 'none';
        loopAllIcon.style.display = mode === 2 ? '' : 'none';
    }

    loopToggleBtn.addEventListener('click', () => {
        loopMode = (loopMode + 1) % 3;
        updateLoopIcon(loopMode);
        loopToggleBtn.classList.toggle('active', loopMode > 0);
    });


    ////////////////////////////// ⏯️ Bouton Play / Pause global
    const playPauseBtn = document.getElementById('play-pause-toggle');
    const playIcon = playPauseBtn.querySelector('#play-icon');
    const pauseIcon = playPauseBtn.querySelector('#pause-icon');

    playPauseBtn.addEventListener('click', () => {
        if (!currentPlaying) return;
        if (currentPlaying.isPlaying()) {
            currentPlaying.pause();
        } else {
            currentPlaying.play();
        }
    });

    // Mises à jour visuelles
    function updatePlayPauseIcon(isPlaying) {
        const playIcon = document.getElementById('play-icon');
        const pauseIcon = document.getElementById('pause-icon');

        if (isPlaying) {
            playIcon.style.display = 'none';
            pauseIcon.style.display = '';
        } else {
            playIcon.style.display = '';
            pauseIcon.style.display = 'none';
        }
    }


    // Met à jour l’icône à chaque changement d’état
    function attachPlayPauseIconUpdates(player) {
        player.on('play', () => updatePlayPauseIcon(true));
        player.on('pause', () => updatePlayPauseIcon(false));
        player.on('finish', () => updatePlayPauseIcon(false));
    }




    ////////////////////////////// ⏭️ Bouton Next
    document.getElementById('next-track').addEventListener('click', () => {
        if (!currentPlaying) return;

        const currentIndex = players.findIndex(p => p.wavesurfer === currentPlaying);
        const nextIndex = (currentIndex + 1) % players.length;
        const nextPlayer = players[nextIndex].wavesurfer;

        currentPlaying.pause();
        nextPlayer.seekTo(0);
        nextPlayer.play();
        currentPlaying = nextPlayer;

        const globalCover = document.getElementById('cover-image');
        const nextCover = document.querySelectorAll('.track')[nextIndex].querySelector('.cover');
        if (nextCover && globalCover) {
            globalCover.src = nextCover.src;
        }

    });


    const muteToggle = document.getElementById('mute-toggle');
    const volumeIcon = document.getElementById('volume-icon');
    const pathOn = volumeIcon.querySelector('#volume-on');
    const pathOff = volumeIcon.querySelector('#volume-off');
    const volumeSlider = document.getElementById('volume-slider');
    let isMuted = false;
    let lastVolume = 1;

    volumeSlider.addEventListener('input', () => {
        const newVolume = parseFloat(volumeSlider.value);
        players.forEach(({ wavesurfer }) => wavesurfer.setVolume(newVolume));
        isMuted = newVolume === 0;
        updateVolumeIcon();
        lastVolume = newVolume;
    });

    muteToggle.addEventListener('click', () => {
        isMuted = !isMuted;
        if (isMuted) {
            players.forEach(({ wavesurfer }) => wavesurfer.setVolume(0));
            volumeSlider.value = 0;
        } else {
            players.forEach(({ wavesurfer }) => wavesurfer.setVolume(lastVolume));
            volumeSlider.value = lastVolume;
        }
        updateVolumeIcon();
    });

    function updateVolumeIcon() {
        pathOn.style.display = isMuted ? 'none' : '';
        pathOff.style.display = isMuted ? '' : 'none';
    }



</script>


</body>
</html>
