<!-- index.html épuré -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>🎵 St Vince – Music & Climate</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/wavesurfer.js"></script>
</head>
<body>

<header class="minimal-header">
    <div class="brand">
        <span class="logo">🎵</span>
        <div class="text-block">
            <div class="title">St Vince</div>
            <div class="subtitle" id="header-sub">Original music with a human soul and an AI spark</div>
        </div>
    </div>
    <div class="language-switch">
        <button onclick="setLanguage('fr')">🇫🇷 FR</button>
        <button onclick="setLanguage('en')">🇬🇧 EN</button>
    </div>
</header>

<main id="content"></main>

<div id="volume-control">
    <button id="rewind-global" title="Rewind current track" aria-label="Rewind current track">
        <svg viewBox="0 0 24 24" width="24" height="24" fill="#888">
            <path d="M11 18V6l-8.5 6L11 18zM13 6v12l8.5-6L13 6z"/>
        </svg>
    </button>

    <!-- Bouton Play/Pause -->
    <button id="play-pause-toggle" title="Play / Pause">
        <svg viewBox="0 0 24 24" width="24" height="24" fill="#888">
            <path id="play-icon" d="M8 5v14l11-7z"/>
            <path id="pause-icon" d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" style="display: none"/>
        </svg>
    </button>

    <!-- Bouton Next -->
    <button id="next-track" title="Next track">
        <svg viewBox="0 0 24 24" width="24" height="24" fill="#888">
            <path d="M7 6v12l8.5-6L7 6zm9 0v12h2V6h-2z"/>
        </svg>
    </button>

    <button id="loop-toggle" title="Loop mode" aria-label="Loop mode">
        <svg id="loop-icon" viewBox="0 0 24 24" width="24" height="24" fill="#888">
            <path d="M7 7h9v2l3-3-3-3v2H6c-1.1 0-2 .9-2 2v4h2V7z"/>
            <text id="loop-label" x="15" y="21" font-size="8" fill="#888">0</text>
        </svg>
    </button>

    <button id="mute-toggle" title="Mute / Unmute">
        <svg id="volume-icon" viewBox="0 0 24 24" width="24" height="24" fill="#888">
            <path id="volume-on" d="M3 9v6h4l5 5V4L7 9H3z"/>
            <path id="volume-off" d="M16.5 12l2.5 2.5-1.5 1.5L15 13.5l-2.5 2.5-1.5-1.5L13.5 12l-2.5-2.5 1.5-1.5L15 10.5l2.5-2.5 1.5 1.5L16.5 12z" style="display: none"/>
        </svg>
    </button>

    <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1">
</div>

<footer>
    <p id="footer-info" style="opacity: 0.5;">Version en cours de chargement…</p>
</footer>

<script>
    let isHiFi = false;
    let currentPlaying = null;
    const players = [];

    const translations = {
        en: {
            downloadHifi: "⬇️ Download in HiFi (.flac)"
        },
        fr: {
            downloadHifi: "⬇️ Télécharger en HiFi (.flac)"
        }
    };

    function formatTime(seconds) {
        const m = Math.floor(seconds / 60);
        const s = Math.floor(seconds % 60);
        return `${m}:${s.toString().padStart(2, '0')}`;
    }

    function getDownloadLink(url) {
        const match = url.match(/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)\//);
        if (match) {
            const fileId = match[1];
            return `https://drive.google.com/uc?export=download&id=${fileId}`;
        }
        return url; // fallback: retourne l'URL telle quelle si ce n’est pas un lien GDrive
    }

    function renderTracks(lang = 'en') {
        fetch('./assets/data/tracks.json')
            .then(res => res.json())
            .then(data => {
                const { tracks, desc } = data;
                const container = document.getElementById('content');
                container.innerHTML = '';
                tracks.forEach(track => {
                    const trackDesc = desc[lang][track.id] || [];
                    const format = isHiFi ? 'wav' : 'mp3';
                    const audioPath = `assets/audio/${format}/${track.file}.${format}`;
                    const hifiPath = track.hifi;

                    const section = document.createElement('section');
                    section.className = 'track';
                    section.setAttribute('data-audio', audioPath);

                    section.innerHTML = `
                  <div class="cover-container">
                    <img src="assets/covers/${track.cover}" class="cover" alt="${track.title}" />
                    <div class="icon-overlay play"></div>
                  </div>
                  <div class="info">
                    <h2>${track.title}</h2>
                    ${trackDesc.map(p => `<p>${p}</p>`).join('')}
                    <div class="waveform"></div>
                    <p class="duration-controls">
                        <span class="duration" style="font-size: 0.8em; color: #666; margin-top: 4px;">00:00 / 00:00</span>
                    </p>
                    <p><a href="${getDownloadLink(track.hifi)}" class="hifi-link" target="_blank" rel="noopener">${translations[lang].downloadHifi}</a></p>
                  </div>
                `;

                    container.appendChild(section);
                });
                initializeWaveSurfers();
            });
    }


    function initializeWaveSurfers() {
        players.length = 0;
        document.querySelectorAll('.track').forEach(track => {
            const container = track.querySelector('.waveform');
            const durationEl = track.querySelector('.duration');
            let isLooping = false;

            const durationElement = track.querySelector('.duration');
            const playbackElement = track.querySelector('.playback-time');
            const coverContainer = track.querySelector('.cover-container');
            const iconOverlay = track.querySelector('.icon-overlay');
            const baseFilename = track.getAttribute('data-audio').match(/([^/]+)\.(mp3|wav)$/)[1];
            const format = isHiFi ? 'wav' : 'mp3';

            const wavesurfer = WaveSurfer.create({
                container,
                waveColor: '#999',
                progressColor: '#ff7b54',
                height: 80,
                responsive: true,
                barWidth: 2,
                cursorColor: '#fff'
            });

            wavesurfer.setVolume(parseFloat(volumeSlider.value));
            wavesurfer.load(`assets/audio/${format}/${baseFilename}.${format}`);

            coverContainer.onclick = () => {
                if (currentPlaying && currentPlaying !== wavesurfer) {
                    currentPlaying.pause();
                }
                wavesurfer.playPause();
                if (wavesurfer.isPlaying()) {
                    currentPlaying = wavesurfer;
                }
            };

            wavesurfer.on('ready', () => {
                const total = formatTime(wavesurfer.getDuration());
                durationEl.textContent = `00:00 / ${total}`;
            });


            wavesurfer.on('audioprocess', () => {
                const current = formatTime(wavesurfer.getCurrentTime());
                const total = formatTime(wavesurfer.getDuration());
                durationEl.textContent = `${current} / ${total}`;
            });


            wavesurfer.on('play', () => {
                iconOverlay.classList.remove('play');
                iconOverlay.classList.add('pause');
            });
            wavesurfer.on('pause', () => {
                iconOverlay.classList.remove('pause');
                iconOverlay.classList.add('play');
            });

            wavesurfer.on('finish', () => {
                iconOverlay.classList.remove('pause');
                iconOverlay.classList.add('play');

                if (loopMode === 1 && currentPlaying === wavesurfer) {
                    wavesurfer.seekTo(0);
                    wavesurfer.play();
                } else if (loopMode === 2) {
                    wavesurfer.seekTo(0);
                    wavesurfer.play();
                } else {
                    currentPlaying = null;
                }
            });



            players.push({ wavesurfer });
        });
    }

    ////////////////////////////// GESTION DE LA LANGUE
    function setLanguage(lang) {
        localStorage.setItem('lang', lang);
        renderTracks(lang);
        document.getElementById('header-sub').textContent =
            lang === 'fr'
                ? "Des musiques originales, composées par un humain et une IA — un reflet musical du climat."
                : "Original music with a human soul and an AI spark";
    }

    window.addEventListener('DOMContentLoaded', () => {
        const lang = localStorage.getItem('lang') || 'en';
        setLanguage(lang);
    });

    ////////////////////////////// VERSION ET PIED DE PAGE
    fetch('version.json')
        .then(res => res.json())
        .then(data => {
            const footer = document.getElementById('footer-info');
            const version = data.version || 'x.x';
            const date = data.buildDate ? ` (${data.buildDate})` : '';
            footer.textContent = `© 2025 Vincent Lagny – Version ${version}${date} – Licence CC BY-NC-SA 4.0`;
        });

    document.getElementById('rewind-global').addEventListener('click', () => {
        if (currentPlaying) {
            currentPlaying.seekTo(0);
        }
    });


    ////////////////////////////// Bouton LOOP
    const rewindBtn = document.getElementById('rewind-global');

    let loopCurrentTrack = false;
    let loopAllTracks = false;

    rewindBtn.addEventListener('click', () => {
        if (currentPlaying) {
            currentPlaying.seekTo(0);
        }
    });

    const loopToggleBtn = document.getElementById('loop-toggle');
    const loopIconLabel = document.getElementById('loop-label');
    let loopMode = 0; // 0 = no loop, 1 = loop current, 2 = loop all

    loopToggleBtn.addEventListener('click', () => {
        loopMode = (loopMode + 1) % 3;

        // Mise à jour visuelle
        loopIconLabel.textContent = loopMode === 0 ? '0' : (loopMode === 1 ? '1' : '∞');

        // Style actif
        loopToggleBtn.classList.toggle('active', loopMode > 0);
    });


    ////////////////////////////// ⏯️ Bouton Play / Pause global
    const playPauseBtn = document.getElementById('play-pause-toggle');
    const playIcon = playPauseBtn.querySelector('#play-icon');
    const pauseIcon = playPauseBtn.querySelector('#pause-icon');

    playPauseBtn.addEventListener('click', () => {
        if (!currentPlaying) return;
        if (currentPlaying.isPlaying()) {
            currentPlaying.pause();
        } else {
            currentPlaying.play();
        }
    });

    // Mises à jour visuelles
    function updatePlayPauseIcon(isPlaying) {
        playIcon.style.display = isPlaying ? 'none' : '';
        pauseIcon.style.display = isPlaying ? '' : 'none';
    }

    // Met à jour l’icône à chaque changement d’état
    function attachPlayPauseIconUpdates(player) {
        player.on('play', () => updatePlayPauseIcon(true));
        player.on('pause', () => updatePlayPauseIcon(false));
        player.on('finish', () => updatePlayPauseIcon(false));
    }

    ////////////////////////////// ⏭️ Bouton Next
    document.getElementById('next-track').addEventListener('click', () => {
        if (!currentPlaying) return;

        const currentIndex = players.findIndex(p => p.wavesurfer === currentPlaying);
        const nextIndex = (currentIndex + 1) % players.length;
        const nextPlayer = players[nextIndex].wavesurfer;

        currentPlaying.pause();
        nextPlayer.seekTo(0);
        nextPlayer.play();
        currentPlaying = nextPlayer;
    });


    const volumeSlider = document.getElementById('volume-slider');
    const muteToggle = document.getElementById('mute-toggle');
    const volumeIcon = document.getElementById('volume-icon');
    const pathOn = volumeIcon.querySelector('#volume-on');
    const pathOff = volumeIcon.querySelector('#volume-off');
    let isMuted = false;
    let lastVolume = 1;

    volumeSlider.addEventListener('input', () => {
        const newVolume = parseFloat(volumeSlider.value);
        players.forEach(({ wavesurfer }) => wavesurfer.setVolume(newVolume));
        isMuted = newVolume === 0;
        updateVolumeIcon();
        lastVolume = newVolume;
    });

    muteToggle.addEventListener('click', () => {
        isMuted = !isMuted;
        if (isMuted) {
            players.forEach(({ wavesurfer }) => wavesurfer.setVolume(0));
            volumeSlider.value = 0;
        } else {
            players.forEach(({ wavesurfer }) => wavesurfer.setVolume(lastVolume));
            volumeSlider.value = lastVolume;
        }
        updateVolumeIcon();
    });

    function updateVolumeIcon() {
        pathOn.style.display = isMuted ? 'none' : '';
        pathOff.style.display = isMuted ? '' : 'none';
    }



</script>


</body>
</html>
