<!-- index.html Ã©purÃ© -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ğŸµ St Vince â€“ Music & Climate</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/wavesurfer.js"></script>
</head>
<body>

<header class="minimal-header">
    <div class="brand">
        <span class="logo">ğŸµ</span>
        <div class="text-block">
            <div class="title">St Vince</div>
            <div class="subtitle" id="header-sub">Original music with a human soul and an AI spark</div>
        </div>
    </div>
    <div class="language-switch">
        <button onclick="setLanguage('fr')">ğŸ‡«ğŸ‡· FR</button>
        <button onclick="setLanguage('en')">ğŸ‡¬ğŸ‡§ EN</button>
    </div>
</header>

<main id="content"></main>

<footer>
    <p>&copy; 2025 Vincent Lagny â€“ Version 1.33 â€“ Licence CC BY-NC-SA 4.0</p>
</footer>

<script>
    let isHiFi = false;
    let currentPlaying = null;
    const players = [];

    const translations = {
        en: {
            downloadHifi: "â¬‡ï¸ Download in HiFi (.flac)"
        },
        fr: {
            downloadHifi: "â¬‡ï¸ TÃ©lÃ©charger en HiFi (.flac)"
        }
    };

    function formatTime(seconds) {
        const m = Math.floor(seconds / 60);
        const s = Math.floor(seconds % 60);
        return `${m}:${s.toString().padStart(2, '0')}`;
    }

    function getDownloadLink(url) {
        const match = url.match(/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)\//);
        if (match) {
            const fileId = match[1];
            return `https://drive.google.com/uc?export=download&id=${fileId}`;
        }
        return url; // fallback: retourne l'URL telle quelle si ce nâ€™est pas un lien GDrive
    }

    function renderTracks(lang = 'en') {
        fetch('./assets/data/tracks.json')
            .then(res => res.json())
            .then(data => {
                const { tracks, desc } = data;
                const container = document.getElementById('content');
                container.innerHTML = '';
                tracks.forEach(track => {
                    const trackDesc = desc[lang][track.id] || [];
                    const format = isHiFi ? 'wav' : 'mp3';
                    const audioPath = `assets/audio/${format}/${track.file}.${format}`;
                    const hifiPath = track.hifi;

                    const section = document.createElement('section');
                    section.className = 'track';
                    section.setAttribute('data-audio', audioPath);

                    section.innerHTML = `
                  <div class="cover-container">
                    <img src="assets/covers/${track.cover}" class="cover" alt="${track.title}" />
                    <div class="icon-overlay play"></div>
                  </div>
                  <div class="info">
                    <h2>${track.title}</h2>
                    ${trackDesc.map(p => `<p>${p}</p>`).join('')}
                    <div class="waveform"></div>
                    <p class="duration-controls">
                        <span class="duration" style="font-size: 0.8em; color: #666; margin-top: 4px;">00:00 / 00:00</span>
                        <button class="rewind" title="Rewind">âª</button>
                        <button class="loop" title="Loop">ğŸ”</button>
                    </p>
                    <p><a href="${getDownloadLink(track.hifi)}" class="hifi-link" target="_blank" rel="noopener">${translations[lang].downloadHifi}</a></p>
                  </div>
                `;

                    container.appendChild(section);
                });
                initializeWaveSurfers();
            });
    }


    function initializeWaveSurfers() {
        players.length = 0;
        document.querySelectorAll('.track').forEach(track => {
            const container = track.querySelector('.waveform');
            const durationEl = track.querySelector('.duration');
            const rewindBtn = track.querySelector('.rewind');
            const loopBtn = track.querySelector('.loop');
            let isLooping = false;

            const durationElement = track.querySelector('.duration');
            const playbackElement = track.querySelector('.playback-time');
            const coverContainer = track.querySelector('.cover-container');
            const iconOverlay = track.querySelector('.icon-overlay');
            const baseFilename = track.getAttribute('data-audio').match(/([^/]+)\.(mp3|wav)$/)[1];
            const format = isHiFi ? 'wav' : 'mp3';

            const wavesurfer = WaveSurfer.create({
                container,
                waveColor: '#999',
                progressColor: '#ff7b54',
                height: 80,
                responsive: true,
                barWidth: 2,
                cursorColor: '#fff'
            });

            wavesurfer.setVolume(parseFloat(volumeSlider.value));
            wavesurfer.load(`assets/audio/${format}/${baseFilename}.${format}`);

            coverContainer.onclick = () => {
                if (currentPlaying && currentPlaying !== wavesurfer) {
                    currentPlaying.pause();
                }
                wavesurfer.playPause();
                if (wavesurfer.isPlaying()) {
                    currentPlaying = wavesurfer;
                }
            };

            wavesurfer.on('ready', () => {
                const total = formatTime(wavesurfer.getDuration());
                durationEl.textContent = `00:00 / ${total}`;
            });


            wavesurfer.on('audioprocess', () => {
                const current = formatTime(wavesurfer.getCurrentTime());
                const total = formatTime(wavesurfer.getDuration());
                durationEl.textContent = `${current} / ${total}`;
            });


            wavesurfer.on('play', () => {
                iconOverlay.classList.remove('play');
                iconOverlay.classList.add('pause');
            });
            wavesurfer.on('pause', () => {
                iconOverlay.classList.remove('pause');
                iconOverlay.classList.add('play');
            });

            rewindBtn.onclick = () => {
                wavesurfer.seekTo(0);
            };

            loopBtn.onclick = () => {
                isLooping = !isLooping;
                loopBtn.classList.toggle('active', isLooping);
            };

            wavesurfer.on('finish', () => {
                iconOverlay.classList.remove('pause');
                iconOverlay.classList.add('play');
                if (isLooping) {
                    wavesurfer.seekTo(0);
                    wavesurfer.play();
                } else {
                    currentPlaying = null;
                    const total = formatTime(wavesurfer.getDuration());
                    durationEl.textContent = `00:00 / ${total}`;
                }
            });

            players.push({ wavesurfer });
        });
    }

    function setLanguage(lang) {
        localStorage.setItem('lang', lang);
        renderTracks(lang);
        document.getElementById('header-sub').textContent =
            lang === 'fr'
                ? "Des musiques originales, composÃ©es par un humain et une IA â€” un reflet musical du climat."
                : "Original music with a human soul and an AI spark";
    }

    window.addEventListener('DOMContentLoaded', () => {
        const lang = localStorage.getItem('lang') || 'en';
        setLanguage(lang);
    });


    const volumeSlider = document.getElementById('volume-slider');
    const muteToggle = document.getElementById('mute-toggle');
    let isMuted = false;
    let lastVolume = 1;

    volumeSlider.addEventListener('input', () => {
        const newVolume = parseFloat(volumeSlider.value);
        players.forEach(({ wavesurfer }) => wavesurfer.setVolume(newVolume));
        isMuted = newVolume === 0;
        muteToggle.textContent = isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
        lastVolume = newVolume;
    });

    muteToggle.addEventListener('click', () => {
        isMuted = !isMuted;
        if (isMuted) {
            players.forEach(({ wavesurfer }) => wavesurfer.setVolume(0));
            muteToggle.textContent = 'ğŸ”‡';
        } else {
            players.forEach(({ wavesurfer }) => wavesurfer.setVolume(lastVolume));
            muteToggle.textContent = 'ğŸ”Š';
            volumeSlider.value = lastVolume;
        }
    });



</script>

<div id="volume-control">
    <button id="mute-toggle" title="Mute / Unmute">ğŸ”Š</button>
    <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1">
</div>

</body>
</html>
